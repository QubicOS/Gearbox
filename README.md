# Gearbox

**Gearbox** — это модульная и расширяемая платформа для встраиваемых систем на базе ESP-IDF, предоставляющая готовые к использованию компоненты уровня production для работы с данными, конфигурацией, безопасностью, телеметрией, логикой приложений и динамической загрузкой кода.

---

## Особенности

- **Безопасное шифрованное хранилище (Vault)**  
  Защищённая подсистема хранения ключей, токенов, состояний и любых данных, с шифрованием AES-256-GCM, TTL, ACL, версионностью и резервным копированием.

- **Модуль взаимодействия (Broker)**  
  Встроенный publish/subscribe-брокер для взаимодействия между задачами и модулями, с приоритетами, подмодулями и внутренним очередным механизмом.

- **Менеджер конфигураций (Config Manager)**  
  Унифицированная работа с параметрами системы: JSON, NVS, VFS, hot-reload, ACL, автоматическое сохранение и on-change callbacks.

- **Система телеметрии (Telemetry)**  
  Сбор, агрегация и экспорт метрик (Prometheus-compatible) через MQTT и HTTP. Поддерживает counter, gauge, histogram, системные метрики, собственные источники и автоматическую публикацию.

- **Состояния и автоматика (STM)**  
  Потокобезопасный фреймворк конечных автоматов с таймаутами, guard-функциями и переходами по событиям.

- **Загрузчик ELF в рантайме**  
  Полноценная поддержка загрузки ELF-файлов в память во время исполнения: `.text`, `.data`, `.bss`, relocations, проверка целостности, вызов `entry()` и полная выгрузка. Позволяет обновлять логику без перепрошивки.

- **Файловая подсистема (FS Layer)**  
  Унифицированный доступ к VFS: SPIFFS, FATFS, LittleFS, SD-карты. Поддержка авто-монтирования, временных и защищённых директорий, интеграция с Vault и логами.

- **Сетевой менеджер (Net Manager)**  
  Управление Wi-Fi, Ethernet, PPPoS и LTE-интерфейсами. Failover, DHCP/DNS, встроенные проверки доступности (ping, DNS), автоматическая публикация событий в Broker.

---

## Архитектура

Gearbox построен как набор независимых компонентов, каждый из которых можно включить в `CMakeLists.txt` и использовать отдельно или совместно. Все компоненты потокобезопасны, используют `esp_osal`, работают с ESP-IDF 5+ и поддерживают режимы с PSRAM.

---

## Компоненты

- `vault` — безопасное зашифрованное хранилище данных (RAM + VFS)
- `broker` — система событий и маршрутизации между задачами (PubSub)
- `config_manager` — централизованное хранилище и валидатор настроек
- `telemetry` — сбор и экспорт метрик в формате Prometheus
- `stm` — декларативные конечные автоматы с таймерами и переходами
- `elf_loader` — загрузка ELF-модулей в рантайме с relocations
- `fs_layer` — абстракция над VFS и точками монтирования
- `net_manager` — интерфейсы, failover, сетевые события

---

## Примеры использования

- Безопасное хранение токенов и сессий в RAM с TTL и ACL
- Подгрузка бизнес-логики или AI-модулей через ELF без перешивки
- Автоматическая загрузка конфигурации по Wi-Fi и MQTT
- Мониторинг состояния устройства через Prometheus и MQTT
- Построение FSM для обработки команд и взаимодействий
- Публикация событий по приходам данных, перезапускам, OTA и т.п.

---

## Почему Gearbox?

- Production-ready: валидированный и протестированный код
- Безопасность: AES-GCM, secure erase, access control
- Расширяемость: любая подсистема легко заменяется/подключается
- ESP-IDF native: минимальные зависимости, низкий overhead
- Поддержка всех платформ ESP (Xtensa + RISC-V)

---

## Совместимость

- ESP-IDF: 5.0 и выше
- Платформы: ESP32, ESP32-S2, ESP32-S3, ESP32-C3, ESP32-C6, ESP32-P4
- Зависимости: `esp_timer`, `nvs_flash`, `esp_osal`, `esp_vfs`, `mbedtls`, `mqtt`, `http_server`, `cJSON`

---

## Начало работы

1. Склонируй репозиторий `gearbox` в `components/` проекта.
2. Включи нужные модули в `CMakeLists.txt` проекта.
3. В `app_main()` инициализируй компоненты:

   - `vault_init()`
   - `cfg_init(cfg_table, ...)`
   - `broker_init()`
   - `tm_start()`
   - `net_manager_start()`
   - `elf_loader_init()`

4. Используй API из соответствующих заголовков (`vault.h`, `telemetry.h`, `broker.h`, `stm.h`, `elf_loader.h` и т.д.)

---

## Лицензия

Apache License 2.0  
© 2023–2025 — Gearbox Core Team & Contributors

---

**Gearbox** — это не просто фреймворк, это фундамент для твоей embedded-системы: безопасной, масштабируемой и готовой к реальному миру.

